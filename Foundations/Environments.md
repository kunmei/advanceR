### 环境
环境是强化作用域的数据结构。本章节将深入探讨环境，深入地描述它的数据结构，使用它去提供你对在词法作用域中所描述的四中词法作用域规则的理解。

环境本身也是一个非常有用的数据机构，因为它们有引用语义。当你修改一个环境变量中的绑定的时候，环境不是被复制的；它随时被修改，引用语义通常
不是需要的，但是是及其有用的。

##### 纲要
- 环境变量基础　介绍一个环境的基础特性，并展示如何创建一个新的。
- 环境中的递归　修改Ｒ中作用域规则的深度，展示它们是如何和每个函数的四中类型的环境所对应的
- 绑定名字到值　描述了名字必须遵循的规则，展示绑定一个名字到变量的一些变化
- 具体的环境　讨论了环境本身作为一个有用的数据机构，以及作为在作用域中独立角色的三个问题

#### 环境变量基础
一个环境的工作是联系，或者绑定变量名称的集合到值的集合。你可以把一个变量认为是一包变量名称。

每个变量名称指向一个存储在内存中的对象

```
e <- new.env()
e$a <- FALSE
e$b <- "a"
e$c <- 2.3
e$d <- 1:3
```
对象不是存活在环境中，因此不同的名字可以指向同一个对象:

```
e$a <- e$d
```
同时它们也可以指向具有同样值的不同的对象

```
e$a <- 1:3
```
如果一个对象没有变量名称指向它，它将被垃圾回收器自动删除。这个过程将在gc章节详细的描述。

每一个环境都有一个父亲，另外一个变量。在图形中，我将会用一个小的黑圆圈代表指向其父亲的点。
父亲环境用来实现词法作用域:如果一个名字没有在环境中发现，Ｒ将寻找其父亲环境。唯一没有父亲的
一个环境是:空的环境。

我们可以使用家庭去隐喻环境。一个环境的祖父是其父亲的父亲，祖先包括所有父环境变量直到空环境。
很少取谈论一个环境的孩子，因为没有向后的链接:给定一个环境没有办法找到它的孩子。

通俗的来说: 一个环境同列表是类似的，但有四个重要的例外:
- 环境中的每一个对象都有一个独特的名字
- 一个环境中的对象不是有序的（例如，询问一个环境中第一个对象是没有意义的）
- 每个环境都有一个父亲
- 环境有引用语义

更技术的来说:一个环境是由两个部分组成的,frame(框架)，包含了名字和对象的绑定（表现地更像是一个名字的列表），
和其父亲环境。不幸的是，在Ｒ中，"frame"使用不是一致的。例如, parent.frame()并没有给出一个环境的父frame。
而是，它会给你调用环境。这将会在calling environment中详细讨论。

有四种特殊的环境:
- globalenv(),或者称为全局环境，是交互工作空间。这是你通常工作的环境。全局环境的父亲是你用library()和
require()加载的最后一个包。
- baseenv(),或者称为基础环境，是base包里面的环境。它的父亲是空的环境。
- emptyenv(),或者称为空的环境，是所有环境最终的祖先，是唯一没有父亲的祖先。
- environment(), 指当前的祖先。

search()会列出全局变量所有的父亲。这被称作搜索路劲，因为在这些变量中的所有对象都可以在最顶层的交互空间被
找到。每一个加载的包都有一个环境，你任何你attach()的其他对象。它还包括一个特殊的叫做Autoloads的环境，
仅仅是当需要加载包对象的时候（例如大的数据集）用来节约资源。

你可以用as.environment()取到搜索列表中的任何环境

```
search()
#> [1] ".GlobalEnv"        "package:stats"     "package:graphics" 
#> [4] "package:grDevices" "package:utils"     "package:datasets" 
#> [7] "package:methods"   "Autoloads"         "package:base"     

as.environment("package:stats")
#> <environment: package:stats>
```
在搜索列表中的globalenv()和baseenv()环境，以及emptyenv() 通过下图相连接。每次你通过library()加载一个新包
的时候，将会被插到全局环境和之前在搜索路径顶部的包之间。

手动创建一个环境，需要使用new.env()。你可以用ls()列出环境结构中所有绑定，用parent.env()查看它的父亲。

```
e <- new.env()
# the default parent provided by new.env() is environment from 
# which it is called - in this case that's the global environment.
parent.env(e)
#> <environment: R_GlobalEnv>
ls(e)
#> character(0)
```
修改一个环境中绑定最简单的方式就是把它当做一个列表:

```
e$a <- 1
e$b <- 2
ls(e)
#> [1] "a" "b"
e$a
#> [1] 1
```
默认的，ls()只会显示不是以.开头的名字。使用all.names = TRUE将会把一个环境中所有绑定的名字显示出来。

```
e$.a <- 2
ls(e)
#> [1] "a" "b"
ls(e, all.names = TRUE)
#> [1] "a"  ".a" "b"
```
另一个有用的方式去查看环境是用ls.str()。它比str()更加有用是因为它把环境中的每个变量都展示出来了。像
ls()一样，它也有all.name的参数。

```
str(e)
#> <environment: 0x273f248>
ls.str(e)
#> a :  num 1
#> b :  num 2
```
给定一个名称，你可以用$, [[, or get()提取出它所绑定的值:
- $ and [[只会查找一个环境变量，如果没有名字绑定的值，将会返回NULL。
- get() 使用常规的作用域规则，如果没有绑定被发现，将抛出一个错误。

```
e$c <- 3
e$c
#> [1] 3
e[["c"]]
#> [1] 3
get("c", envir = e)
#> [1] 3
```
从环境中删除一个变量和列表工作起来有点不一样。在列表中，你可以通过设置其为NULL,将一个元素删除。在环境中，
将创建一个新的绑定到NULL,然而，可以用rm()删除一个绑定。

```
e <- new.env()

e$a <- 1
e$a <- NULL
ls(e)
#> [1] "a"

rm("a", envir = e)
ls(e)
#> character(0)
```














